<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Task Manager (No CSS)</title>
</head>
<body>

<div id="nav-section" style="display: none;">
    <h1>Task Manager System</h1>
    <p>
        Hello, <b id="display-username">User</b> |
        <button onclick="logout()">Logout</button>
    </p>
    <hr>
    <nav>
        <button onclick="showPage('dashboard')">Dashboard</button> |
        <button onclick="showPage('my-tasks')">My Tasks</button> |
        <button onclick="showPage('invitations')">Invitations (<span id="invite-count">0</span>)</button> |
        <button onclick="showPage('users')">Users Directory</button>
    </nav>
    <hr>
</div>

<div id="notification-area" style="color: red; font-weight: bold; padding: 10px;"></div>

<div id="page-login">
    <h2>Login</h2>
    <form onsubmit="handleLogin(event)">
        <label>Username:</label><br>
        <input type="text" id="login-user" required><br><br>

        <label>Password:</label><br>
        <input type="password" id="login-pass" required><br><br>

        <button type="submit">Login</button>
    </form>
    <p>Don't have an account? <button onclick="showPage('register')">Register here</button></p>
</div>

<div id="page-register" style="display: none;">
    <h2>Register New Account</h2>
    <form onsubmit="handleRegister(event)">
        <label>Username (min 4):</label><br>
        <input type="text" id="reg-user" required><br><br>

        <label>Password (min 6, complex):</label><br>
        <input type="password" id="reg-pass" required><br><br>

        <label>First Name:</label><br>
        <input type="text" id="reg-first"><br><br>

        <label>Last Name:</label><br>
        <input type="text" id="reg-last"><br><br>

        <button type="submit">Register</button>
        <button type="button" onclick="showPage('login')">Cancel</button>
    </form>
</div>

<div id="page-dashboard" style="display: none;">
    <h2>Dashboard</h2>
    <ul>
        <li>Total Tasks: <b id="stat-total">0</b></li>
        <li>Completed: <b id="stat-done">0</b></li>
        <li>In Progress: <b id="stat-progress">0</b></li>
        <li>Pending Invitations: <b id="stat-invite">0</b></li>
    </ul>
    <hr>
    <h3>Recent Tasks</h3>
    <ul id="dashboard-list"></ul>
</div>

<div id="page-my-tasks" style="display: none;">
    <h2>My Tasks</h2>
    <button onclick="showCreateTaskForm()">+ Add New Task</button>
    <div id="create-task-form" style="display: none; border: 1px solid black; padding: 10px; margin: 10px 0;">
        <h3>New Task Form</h3>
        <form onsubmit="handleCreateTask(event)">
            Title: <input type="text" id="new-title" required><br>
            Desc: <textarea id="new-desc"></textarea><br>
            Status:
            <select id="new-status">
                <option value="TODO">TODO</option>
                <option value="IN_PROGRESS">IN_PROGRESS</option>
                <option value="DONE">DONE</option>
            </select><br>
            Priority:
            <select id="new-priority">
                <option value="LOW">LOW</option>
                <option value="MEDIUM">MEDIUM</option>
                <option value="HIGH">HIGH</option>
            </select><br>
            Deadline: <input type="date" id="new-deadline"><br><br>
            <button type="submit">Save Task</button>
            <button type="button" onclick="document.getElementById('create-task-form').style.display='none'">Cancel</button>
        </form>
    </div>

    <hr>
    <div id="task-list-container">Loading...</div>
</div>

<div id="page-task-detail" style="display: none;">
    <button onclick="showPage('my-tasks')"><< Back to List</button>
    <h2 id="detail-title">Task Title</h2>

    <fieldset>
        <legend>Info</legend>
        <p><b>ID:</b> <span id="detail-id"></span></p>
        <p><b>Status:</b> <span id="detail-status"></span></p>
        <p><b>Priority:</b> <span id="detail-priority"></span></p>
        <p><b>Deadline:</b> <span id="detail-deadline"></span></p>
        <p><b>Owner:</b> <span id="detail-owner"></span></p>
        <p><b>Description:</b> <br> <span id="detail-desc"></span></p>

    </fieldset>
    <!-- === ADD SUBTASK SECTION HERE === -->
    <fieldset>
        <legend>Sub Tasks</legend>

        <button onclick="showCreateSubTaskForm()">+ Add Sub Task</button>

        <div id="create-subtask-form"
             style="display:none; border:1px solid black; padding:10px; margin:10px 0;">
            <h4>New SubTask</h4>
            <form onsubmit="handleCreateSubTask(event)">
                Title: <input type="text" id="sub-title" required><br>
                Desc: <textarea id="sub-desc"></textarea><br>

                Status:
                <select id="sub-status">
                    <option value="TODO">TODO</option>
                    <option value="IN_PROGRESS">IN_PROGRESS</option>
                    <option value="DONE">DONE</option>
                </select><br>

                Priority:
                <select id="sub-priority">
                    <option value="LOW">LOW</option>
                    <option value="MEDIUM">MEDIUM</option>
                    <option value="HIGH">HIGH</option>
                </select><br>

                Deadline: <input type="date" id="sub-deadline"><br><br>

                <button type="submit">Create SubTask</button>
                <button type="button"
                        onclick="document.getElementById('create-subtask-form').style.display='none'">
                    Cancel
                </button>
            </form>
        </div>


        <ul id="subtask-list"></ul>
        <div id="edit-subtask-form"
             style="display:none; border:1px dashed black; padding:10px; margin-top:10px;">
            <h4>Edit SubTask</h4>
            <form onsubmit="handleUpdateSubTask(event)">
                Title: <input type="text" id="edit-sub-title"><br>
                Desc: <textarea id="edit-sub-desc"></textarea><br>

                Status:
                <select id="edit-sub-status">
                    <option value="TODO">TODO</option>
                    <option value="IN_PROGRESS">IN_PROGRESS</option>
                    <option value="DONE">DONE</option>
                </select><br>

                Priority:
                <select id="edit-sub-priority">
                    <option value="LOW">LOW</option>
                    <option value="MEDIUM">MEDIUM</option>
                    <option value="HIGH">HIGH</option>
                </select><br>

                Deadline: <input type="date" id="edit-sub-deadline"><br><br>

                <button type="submit">Update</button>
                <button type="button"
                        onclick="document.getElementById('edit-subtask-form').style.display='none'">
                    Cancel
                </button>
            </form>
        </div>

    </fieldset>
    <!-- === END SUBTASK SECTION === -->

    <fieldset>
        <legend>Members</legend>
        <ul id="detail-members"></ul>
        <h4>Invite User</h4>
        <select id="invite-user-select"></select>
        <button onclick="handleInviteMember()">Send Invitation</button>
    </fieldset>

    <h3>Actions</h3>
    <button onclick="enableEditMode()">Edit Task</button>
    <button onclick="handleDeleteTask()">Delete Task</button>

    <div id="edit-task-form" style="display: none; border: 1px dashed black; padding: 10px; margin-top: 20px;">
        <h3>Edit Task</h3>
        <form onsubmit="handleUpdateTask(event)">
            Title: <input type="text" id="edit-title"><br>
            Desc: <textarea id="edit-desc"></textarea><br>
            Status:
            <select id="edit-status">
                <option value="TODO">TODO</option>
                <option value="IN_PROGRESS">IN_PROGRESS</option>
                <option value="DONE">DONE</option>
            </select><br>
            Priority:
            <select id="edit-priority">
                <option value="LOW">LOW</option>
                <option value="MEDIUM">MEDIUM</option>
                <option value="HIGH">HIGH</option>
            </select><br>
            Deadline: <input type="date" id="edit-deadline"><br><br>
            <button type="submit">Update</button>
            <button type="button" onclick="document.getElementById('edit-task-form').style.display='none'">Cancel</button>
        </form>
    </div>
</div>

<div id="page-invitations" style="display: none;">
    <h2>My Invitations</h2>
    <div id="invitation-list"></div>
</div>

<div id="page-users" style="display: none;">
    <h2>Users Directory</h2>

    <h3>Add User</h3>
    <form onsubmit="handleCreateUser(event)">
        User: <input type="text" id="add-u-name" placeholder="Username" required>
        Pass: <input type="text" id="add-u-pass" placeholder="Password" required>
        First: <input type="text" id="add-u-first">
        Last: <input type="text" id="add-u-last">
        <button type="submit">Add</button>
    </form>
    <hr>
    <h3>All Users</h3>
    <ul id="user-list"></ul>
</div>

<script>
    // CONFIG
    const API_BASE = 'http://localhost:8386/tmdemo1';
    let token = localStorage.getItem('token');
    let currentTaskId = null; // Used for detail view
    let taskDataCache = []; // Store tasks locally for simple stats
    let editingSubTaskId = null;

    // INIT
    window.onload = function() {
        if (token) {
            document.getElementById('display-username').innerText = localStorage.getItem('username') || 'User';
            showPage('dashboard');
            loadDashboardData();
        } else {
            showPage('login');
        }
    };

    // --- NAVIGATION & UI HELPERS ---
    function showPage(pageId) {
        // Hide all pages
        const pages = ['login', 'register', 'dashboard', 'my-tasks', 'task-detail', 'invitations', 'users'];
        pages.forEach(p => document.getElementById('page-' + p).style.display = 'none');

        // Logic for Nav Bar Visibility
        if (pageId === 'login' || pageId === 'register') {
            document.getElementById('nav-section').style.display = 'none';
        } else {
            document.getElementById('nav-section').style.display = 'block';
        }

        // Show selected page
        document.getElementById('page-' + pageId).style.display = 'block';

        // Trigger data load
        if (pageId === 'dashboard') loadDashboardData();
        if (pageId === 'my-tasks') loadMyTasks();
        if (pageId === 'invitations') loadInvitations();
        if (pageId === 'users') loadUsers();

        clearMsg();
    }

    function showMsg(msg) {
        document.getElementById('notification-area').innerText = msg;
        setTimeout(() => { document.getElementById('notification-area').innerText = ''; }, 3000);
    }
    function clearMsg() { document.getElementById('notification-area').innerText = ''; }

    // --- API HELPER ---
    async function apiCall(endpoint, method = 'GET', body = null) {
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        try {
            const res = await fetch(API_BASE + endpoint, options);
            const data = await res.json();
            return data;
        } catch (err) {
            console.error(err);
            showMsg("Network Error");
            return null;
        }
    }

    // --- AUTH ---
    async function handleLogin(e) {
        e.preventDefault();
        const un = document.getElementById('login-user').value;
        const pw = document.getElementById('login-pass').value;

        const res = await apiCall('/auth/log-in', 'POST', { username: un, password: pw });
        if (res && res.code === 200) {
            token = res.result; // Token string
            localStorage.setItem('token', token);
            localStorage.setItem('username', un);
            document.getElementById('display-username').innerText = un;
            showPage('dashboard');
        } else {
            showMsg(res ? res.message : "Login Failed");
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const body = {
            username: document.getElementById('reg-user').value,
            password: document.getElementById('reg-pass').value,
            firstName: document.getElementById('reg-first').value,
            lastName: document.getElementById('reg-last').value
        };
        const res = await apiCall('/users', 'POST', body);
        if (res && res.code === 200) {
            alert("Registered Successfully! Please Login.");
            showPage('login');
        } else {
            showMsg("Register Failed: " + (res?.message || 'Unknown'));
        }
    }

    function logout() {
        token = null;
        localStorage.clear();
        showPage('login');
    }

    // --- DASHBOARD ---
    async function loadDashboardData() {
        const res = await apiCall('/tasks/my');
        const invites = await apiCall('/tasks/invitations');

        if (res && res.result) {
            taskDataCache = res.result;
            // Simple stats
            document.getElementById('stat-total').innerText = taskDataCache.length;
            document.getElementById('stat-done').innerText = taskDataCache.filter(t => t.status === 'DONE').length;
            document.getElementById('stat-progress').innerText = taskDataCache.filter(t => t.status === 'IN_PROGRESS').length;

            // Render Recent
            const list = document.getElementById('dashboard-list');
            list.innerHTML = '';
            taskDataCache.slice(0, 5).forEach(t => {
                list.innerHTML += `<li><b>${t.title}</b> [${t.status}] - <button onclick="openDetail(${t.id})">View</button></li>`;
            });
        }

        if (invites && invites.result) {
            document.getElementById('stat-invite').innerText = invites.result.length;
            document.getElementById('invite-count').innerText = invites.result.length;
        }
    }

    // --- TASKS ---
    async function loadMyTasks() {
        document.getElementById('task-list-container').innerText = 'Loading...';
        const res = await apiCall('/tasks/my');
        const container = document.getElementById('task-list-container');
        container.innerHTML = '';

        if (res && res.result) {
            if (res.result.length === 0) container.innerHTML = "No tasks found.";

            const ul = document.createElement('ul');
            res.result.forEach(t => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>${t.title}</strong>
                    <br> Status: ${t.status} | Priority: ${t.priority}
                    <br> <button onclick="openDetail(${t.id})">Details / Edit</button>
                    <button onclick="deleteTask(${t.id})">Delete</button>
                    <hr>
                `;
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }
    }
    // === ADD LOAD SUBTASK HERE ===
    async function loadSubTasks(taskId) {
        const res = await apiCall(`/tasks/${taskId}/subtasks`);
        const ul = document.getElementById('subtask-list');
        ul.innerHTML = '';

        if (res && res.result && res.result.length > 0) {
            res.result.forEach(t => {
                ul.innerHTML += `
                    <li style="margin-left:20px;">
                        <b>${t.title}</b>
                        | ${t.status}
                        | ${t.priority}
                        | ${t.deadline || 'No deadline'}
                        <br>
                        <button onclick="openDetail(${t.id})">View</button>
                        <button onclick="showEditSubTask(${t.id})">Edit</button>
                        <button onclick="deleteSubTask(${t.id})">Delete</button>
                    </li>
                `;
            });
        } else {
            ul.innerHTML = '<li>No subtasks</li>';
        }
    }


    // === ADD SUBTASK FORM TOGGLE HERE ===
    function showCreateSubTaskForm() {
        document.getElementById('create-subtask-form').style.display = 'block';
    }

    function showCreateTaskForm() {
        document.getElementById('create-task-form').style.display = 'block';
    }

    async function handleCreateTask(e) {
        e.preventDefault();
        const body = {
            title: document.getElementById('new-title').value,
            description: document.getElementById('new-desc').value,
            status: document.getElementById('new-status').value,
            priority: document.getElementById('new-priority').value,
            deadline: document.getElementById('new-deadline').value || null
        };
        const res = await apiCall('/tasks', 'POST', body);
        if (res && res.code === 200) {
            showMsg("Task Created!");
            document.getElementById('create-task-form').style.display = 'none';
            e.target.reset();
            loadMyTasks();
            loadDashboardData(); // â­ ADD

        } else {
            showMsg("Create Failed");
        }
    }
    // === ADD CREATE SUBTASK HERE ===
        async function handleCreateSubTask(e) {
            e.preventDefault();

            const body = {
                title: document.getElementById('sub-title').value,
                description: document.getElementById('sub-desc').value,
                status: document.getElementById('sub-status').value,
                priority: document.getElementById('sub-priority').value,
                deadline: document.getElementById('sub-deadline').value || null,
                parentTaskId: currentTaskId
            };

            const res = await apiCall('/tasks', 'POST', body);
            if (res && res.code === 200) {
                showMsg("SubTask created");
                e.target.reset();
                document.getElementById('create-subtask-form').style.display = 'none';
                loadSubTasks(currentTaskId);
            } else {
                showMsg("Create SubTask failed");
            }
        }


    async function deleteTask(id) {
        if(!confirm("Delete this task?")) return;
        const res = await apiCall(`/tasks/${id}`, 'DELETE');
        if (res) {
            showMsg("Deleted.");
            loadMyTasks();
        }
    }

    // --- DETAIL & EDIT ---
    async function openDetail(id) {
        currentTaskId = id;
        showPage('task-detail');
        const res = await apiCall(`/tasks/${id}`);
        if (res && res.result) {
            const t = res.result;
            document.getElementById('detail-title').innerText = t.title;
            document.getElementById('detail-id').innerText = t.id;
            document.getElementById('detail-status').innerText = t.status;
            document.getElementById('detail-priority').innerText = t.priority;
            document.getElementById('detail-deadline').innerText = t.deadline;
            document.getElementById('detail-desc').innerText = t.description;
            document.getElementById('detail-owner').innerText = t.owner ? t.owner.username : 'N/A';

            // Members
            const memList = document.getElementById('detail-members');
            memList.innerHTML = '';
            if (t.members) {
                t.members.forEach(m => {
                    memList.innerHTML += `<li>${m.username} (${m.fullName})</li>`;
                });
            }

            // Load users for invite dropdown
            loadUsersForInvite();
            loadSubTasks(id);
        }
    }

    function enableEditMode() {
        const form = document.getElementById('edit-task-form');
        form.style.display = 'block';

        // Pre-fill
        document.getElementById('edit-title').value = document.getElementById('detail-title').innerText;
        document.getElementById('edit-desc').value = document.getElementById('detail-desc').innerText;
        document.getElementById('edit-status').value = document.getElementById('detail-status').innerText;
        document.getElementById('edit-priority').value = document.getElementById('detail-priority').innerText;
        document.getElementById('edit-deadline').value = document.getElementById('detail-deadline').innerText;
    }

    async function handleUpdateTask(e) {
        e.preventDefault();
        const body = {
            title: document.getElementById('edit-title').value,
            description: document.getElementById('edit-desc').value,
            status: document.getElementById('edit-status').value,
            priority: document.getElementById('edit-priority').value,
            deadline: document.getElementById('edit-deadline').value || null
        };
        const res = await apiCall(`/tasks/${currentTaskId}`, 'PUT', body);
        if (res && res.code === 200) {
            alert("Updated!");
            document.getElementById('edit-task-form').style.display = 'none';
            openDetail(currentTaskId); // Reload detail
        } else {
            showMsg("Update Failed");
        }
    }

    async function handleDeleteTask() {
        if(!confirm("Delete this task currently viewing?")) return;
        await apiCall(`/tasks/${currentTaskId}`, 'DELETE');
        showPage('my-tasks');
    }

    // --- INVITATIONS ---
    async function loadUsersForInvite() {
        const res = await apiCall('/users');
        const sel = document.getElementById('invite-user-select');
        sel.innerHTML = '';
        if (res && res.result) {
            res.result.forEach(u => {
                sel.innerHTML += `<option value="${u.id}">${u.username}</option>`;
            });
        }
    }

    async function handleInviteMember() {
        const uid = document.getElementById('invite-user-select').value;
        const res = await apiCall(`/tasks/${currentTaskId}/members/${uid}/invite`, 'POST');
        if(res && res.code === 200) {
            alert("Invited!");
        } else {
            alert("Invite failed");
        }
    }

    async function loadInvitations() {
        const res = await apiCall('/tasks/invitations');
        const div = document.getElementById('invitation-list');
        div.innerHTML = '';

        if (res && res.result && res.result.length > 0) {
            res.result.forEach(t => {
                div.innerHTML += `
                    <div style="border:1px solid black; margin:5px; padding:5px;">
                        <h3>${t.title}</h3>
                        <p>From: ${t.owner ? t.owner.username : '?'}</p>
                        <button onclick="respondInvite(${t.id}, 'accept')">Accept</button>
                        <button onclick="respondInvite(${t.id}, 'reject')">Reject</button>
                    </div>
                `;
            });
        } else {
            div.innerHTML = "<p>No invitations.</p>";
        }
    }

    async function respondInvite(tid, action) {
        await apiCall(`/tasks/${tid}/${action}`, 'POST');
        loadInvitations();
        loadDashboardData(); // Update badge
    }
    async function showEditSubTask(id) {
        const res = await apiCall(`/tasks/${id}`);
        if (!res || !res.result) return;

        const t = res.result;
        editingSubTaskId = id;

        document.getElementById('edit-sub-title').value = t.title;
        document.getElementById('edit-sub-desc').value = t.description;
        document.getElementById('edit-sub-status').value = t.status;
        document.getElementById('edit-sub-priority').value = t.priority;
        document.getElementById('edit-sub-deadline').value = t.deadline || '';

        document.getElementById('edit-subtask-form').style.display = 'block';
    }

    async function handleUpdateSubTask(e) {
        e.preventDefault();

        const body = {
            title: document.getElementById('edit-sub-title').value,
            description: document.getElementById('edit-sub-desc').value,
            status: document.getElementById('edit-sub-status').value,
            priority: document.getElementById('edit-sub-priority').value,
            deadline: document.getElementById('edit-sub-deadline').value || null
        };

        const res = await apiCall(`/tasks/${editingSubTaskId}`, 'PUT', body);
        if (res && res.code === 200) {
            showMsg("SubTask updated");
            document.getElementById('edit-subtask-form').style.display = 'none';
            loadSubTasks(currentTaskId);
        }
    }
    async function deleteSubTask(id) {
    if (!confirm("Delete this subtask?")) return;
    await apiCall(`/tasks/${id}`, 'DELETE');
    loadSubTasks(currentTaskId);
}

    // --- USERS ---
    async function loadUsers() {
        const res = await apiCall('/users');
        const list = document.getElementById('user-list');
        list.innerHTML = '';
        if (res && res.result) {
            res.result.forEach(u => {
                list.innerHTML += `<li>${u.username} (${u.firstName} ${u.lastName}) <button onclick="deleteUser(${u.id})">Delete</button></li>`;
            });
        }
    }

    async function handleCreateUser(e) {
        e.preventDefault();
        const body = {
            username: document.getElementById('add-u-name').value,
            password: document.getElementById('add-u-pass').value,
            firstName: document.getElementById('add-u-first').value,
            lastName: document.getElementById('add-u-last').value
        };
        const res = await apiCall('/users', 'POST', body);
        if(res && res.code === 200) {
            showMsg("User Added");
            e.target.reset();
            loadUsers();
        } else {
            showMsg("Add User Failed");
        }
    }

    async function deleteUser(id) {
        if(!confirm("Delete user?")) return;
        await apiCall(`/users/${id}`, 'DELETE');
        loadUsers();
    }

</script>
</body>
</html>